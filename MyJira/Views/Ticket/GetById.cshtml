@using MyJira.Services.DTO
@model TicketByIdDTO

<div class="container my-5">

    <!-- Карточка тикета -->
    <div class="card shadow-sm">
        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
            <div class="d-flex align-items-center gap-3">
                <h5 class="mb-0">@Model.Ticket.Code - @Model.Ticket.Id</h5>

                <span class="badge @(Model.Ticket.Type == TicketType.Bug ? "bg-danger" : "bg-success")">
                    @Model.Ticket.Type
                </span>

                <select id="boardSelect" class="form-select form-select-sm" style="width:auto;" data-ticketid="@Model.Ticket.Id">
                    @foreach (var board in Model.Boards)
                    {
                        @: <option value="@board.Id" @(board.Id == Model.CurrentBoard.Id ? "selected" : "")>@board.Name</option>
                    }
                </select>

            </div>
        </div>

        <div class="card-body">
            <h5 class="card-title">@Model.Ticket.Title</h5>

            @if (!string.IsNullOrWhiteSpace(Model.Ticket.Description))
            {
                <p class="card-text"><strong>Описание:</strong> @Model.Ticket.Description</p>
            }

            <p class="card-text"><strong>Испольнитель:</strong> @Model.Ticket.UserName</p>
            <p class="mb-1"><strong>Старт:</strong> @Model.Ticket.Start.ToString("dd.MM.yyyy HH:mm")</p>
            <p class="mb-1">
                <strong>Окончание:</strong> @(Model.Ticket.End.HasValue ? Model.Ticket.End.Value.ToString("dd.MM.yyyy HH:mm") : "—")
            </p>
        </div>

        <div class="card-footer text-muted d-flex justify-content-between align-items-center">
            <small>Информация о тикете</small>
          <div class="d-flex gap-2">
    <button id="toggleComments" class="btn btn-outline-secondary btn-sm" data-ticketid="@Model.Ticket.Id">
        Комментарии
    </button>

    <button id="toggleTaskLogs" class="btn btn-outline-dark btn-sm" data-ticketid="@Model.Ticket.Id">
        История таска
    </button>

    @if (User.Identity.IsAuthenticated)
    {
        <button id="toggleAddComment" class="btn btn-outline-primary btn-sm">
            Добавить комментарий
        </button>
    }
</div>
        </div>
    </div>

    <!-- Блок комментариев -->
    <div id="commentsSection" class="mt-3" style="display:none;">
        <div class="card">
            <div class="card-body" id="commentsContainer">
                <p class="text-muted">Загрузка комментариев...</p>
            </div>
        </div>
    </div>

    <!-- История таска -->
<div id="taskLogsSection" class="mt-3" style="display:none;">
    <div class="card">
        <div class="card-body" id="taskLogsContainer">
            <p class="text-muted">Загрузка истории...</p>
        </div>
    </div>
</div>

    @* Подключаем PartialView добавления комментария из папки Comment *@
    @if (User.Identity.IsAuthenticated)
    {
        @Html.Partial("~/Views/Comment/_AddComment.cshtml", new CommentDTO { TicketId = Model.Ticket.Id })
    }
</div>

@section Scripts {
    <script>
        document.addEventListener("DOMContentLoaded", () => {

            // Перемещение тикета между Board
            const boardSelect = document.querySelector("#boardSelect");
            if (boardSelect) {
                boardSelect.addEventListener("change", async (e) => {
                    const newBoardId = parseInt(e.target.value, 10);
                    const ticketId = parseInt(e.target.dataset.ticketid, 10);

                    try {
                        await fetch("/Ticket/Move", {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify({ ticketId, newBoardId })
                        });
                        alert("✅ Тикет перемещён на новый Board!");
                    } catch (err) {
                        alert("Ошибка при перемещении Board");
                    }
                });
            }

            // Загрузка комментариев
            const toggleBtn = document.getElementById("toggleComments");
            const commentsSection = document.getElementById("commentsSection");
            const commentsContainer = document.getElementById("commentsContainer");

            if (toggleBtn) {
                toggleBtn.addEventListener("click", async () => {
                    const ticketId = toggleBtn.dataset.ticketid;

                    if (commentsSection.style.display === "none") {
                        commentsSection.style.display = "block";
                        toggleBtn.textContent = "Скрыть комментарии";

                        try {
                            const response = await fetch(`/Ticket/GetComments?ticketId=${ticketId}`);
                            const html = await response.text();
                            commentsContainer.innerHTML = html;
                        } catch (err) {
                            commentsContainer.innerHTML = "<p class='text-danger'>Ошибка при загрузке комментариев</p>";
                        }
                    } else {
                        commentsSection.style.display = "none";
                        toggleBtn.textContent = "Показать комментарии";
                    }
                });
            }

            // Показ/скрытие блока добавления комментария
            const toggleAddBtn = document.getElementById("toggleAddComment");
            const addCommentSection = document.getElementById("addCommentSection");

            if (toggleAddBtn && addCommentSection) {
                toggleAddBtn.addEventListener("click", () => {
                    if (addCommentSection.style.display === "none") {
                        addCommentSection.style.display = "block";
                        toggleAddBtn.textContent = "Скрыть добавление комментария";
                    } else {
                        addCommentSection.style.display = "none";
                        toggleAddBtn.textContent = "Добавить комментарий";
                    }
                });
            }

             const submitBtn = document.getElementById("submitComment");
    const commentText = document.getElementById("commentText");

    if (submitBtn && commentText) {
        submitBtn.addEventListener("click", async () => {
            const ticketId = submitBtn.dataset.ticketid;
            const text = commentText.value.trim();

            if (!text) {
                alert("Введите текст комментария!");
                return;
            }

            try {
                const response = await fetch("/Comment/Add", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ ticketId: parseInt(ticketId, 10), text })
                });

                if (response.ok) {
                    commentText.value = "";
                    alert("Комментарий добавлен!");

                    // Обновляем список комментариев после добавления
                    const commentsContainer = document.getElementById("commentsContainer");
                    if (commentsContainer) {
                        const commentsResponse = await fetch(`/Ticket/GetComments?ticketId=${ticketId}`);
                        const html = await commentsResponse.text();
                        commentsContainer.innerHTML = html;
                    }
                } else {
                    alert("Ошибка при добавлении комментария");
                }
            } catch {
                alert("Ошибка при добавлении комментария");
            }
        });

        const toggleTaskLogs = document.getElementById("toggleTaskLogs");
const taskLogsSection = document.getElementById("taskLogsSection");
const taskLogsContainer = document.getElementById("taskLogsContainer");

if (toggleTaskLogs) {
    toggleTaskLogs.addEventListener("click", async () => {
        const ticketId = toggleTaskLogs.dataset.ticketid;

        // скрываем комментарии если открыты
        commentsSection.style.display = "none";
        toggleBtn.textContent = "Комментарии";

        if (taskLogsSection.style.display === "none") {
            taskLogsSection.style.display = "block";
            toggleTaskLogs.textContent = "Скрыть историю";

            try {
                const response = await fetch(`/Ticket/GetTaskLogs?ticketId=${ticketId}`);
                const html = await response.text();
                taskLogsContainer.innerHTML = html;
            } catch {
                taskLogsContainer.innerHTML = "<p class='text-danger'>Ошибка загрузки истории</p>";
            }
        } else {
            taskLogsSection.style.display = "none";
            toggleTaskLogs.textContent = "История таска";
        }
    });
}

    }
        });
    </script>
}