@using MyJira.Services.DTO
@model TicketByIdDTO

<div class="container my-5">

    <!-- Карточка тикета -->
    <div class="card shadow-sm">
        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
            <div class="d-flex align-items-center gap-3">

                <h5 class="mb-0">@Model.Ticket.Code - @Model.Ticket.Id</h5>

                <span class="badge @(Model.Ticket.Type == TicketType.Bug ? "bg-danger" : "bg-success")">
                    @Model.Ticket.Type
                </span>

                <select id="boardSelect" class="form-select form-select-sm" style="width:auto;" data-ticketid="@Model.Ticket.Id">
                    @foreach (var board in Model.Boards)
                    {
                        @: <option value="@board.Id" @(board.Id == Model.CurrentBoard.Id ? "selected" : "")>@board.Name</option>
                    }
                </select>
            </div>
        </div>

        <div class="card-body">
            <h5 class="card-title">@Model.Ticket.Title</h5>

            @if (!string.IsNullOrWhiteSpace(Model.Ticket.Description))
            {
                <p class="card-text"><strong>Описание:</strong> @Model.Ticket.Description</p>
            }
              <p class="card-text"><strong>Испольнитель:</strong> @Model.Ticket.UserName</p>
            <p class="mb-1"><strong>Старт:</strong> @Model.Ticket.Start.ToString("dd.MM.yyyy HH:mm")</p>
            <p class="mb-1">
                <strong>Окончание:</strong> @(Model.Ticket.End.HasValue ? Model.Ticket.End.Value.ToString("dd.MM.yyyy HH:mm") : "—")
            </p>
        </div>

        <div class="card-footer text-muted d-flex justify-content-between align-items-center">
            <small>Информация о тикете</small>
            <button id="toggleComments" class="btn btn-outline-secondary btn-sm" data-ticketid="@Model.Ticket.Id">
                Показать комментарии
            </button>
        </div>
    </div>

    <!-- Блок комментариев -->
    <div id="commentsSection" class="mt-3" style="display:none;">
        <div class="card">
            <div class="card-body" id="commentsContainer">
                <p class="text-muted">Загрузка комментариев...</p>
            </div>
        </div>
    </div>

</div>

@section Scripts {
    <script>
        document.addEventListener("DOMContentLoaded", () => {

            // Перемещение тикета между Board
            const boardSelect = document.querySelector("#boardSelect");
            if (boardSelect) {
                boardSelect.addEventListener("change", async (e) => {
                    const newBoardId = parseInt(e.target.value, 10);
                    const ticketId = parseInt(e.target.dataset.ticketid, 10);

                    try {
                        await fetch("/Ticket/Move", {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify({ ticketId, newBoardId })
                        });
                        alert("✅ Тикет перемещён на новый Board!");
                    } catch (err) {
                        alert("Ошибка при перемещении Board");
                    }
                });
            }

            // Загрузка комментариев при нажатии
            const toggleBtn = document.getElementById("toggleComments");
            const commentsSection = document.getElementById("commentsSection");
            const commentsContainer = document.getElementById("commentsContainer");

            if (toggleBtn) {
                toggleBtn.addEventListener("click", async () => {
                    const ticketId = toggleBtn.dataset.ticketid;

                    if (commentsSection.style.display === "none") {
                        commentsSection.style.display = "block";
                        toggleBtn.textContent = "Скрыть комментарии";

                        try {
                            const response = await fetch(`/Ticket/GetComments?ticketId=${ticketId}`);
                            const html = await response.text();
                            commentsContainer.innerHTML = html;
                        } catch (err) {
                            commentsContainer.innerHTML = "<p class='text-danger'>Ошибка при загрузке комментариев</p>";
                        }
                    } else {
                        commentsSection.style.display = "none";
                        toggleBtn.textContent = "Показать комментарии";
                    }
                });
            }
        });
    </script>
}