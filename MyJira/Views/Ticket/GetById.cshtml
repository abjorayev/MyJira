@using MyJira.Services.DTO
@model TicketByIdDTO

<div class="container my-5">

    <!-- Карточка тикета -->
    <div class="card shadow-sm">
        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
            <div class="d-flex align-items-center gap-3">

                <!-- Заголовок тикета -->
                <h5 class="mb-0">@Model.Ticket.Code - @Model.Ticket.Id</h5>

                <!-- Тип тикета (оставляем как было) -->
                <span class="badge @(Model.Ticket.Type == TicketType.Bug ? "bg-danger" : "bg-success")">
                    @Model.Ticket.Type
                </span>

                <!-- Dropdown для Board -->
                <select id="boardSelect" class="form-select form-select-sm" style="width:auto;" data-ticketid="@Model.Ticket.Id">
                    @foreach (var board in Model.Boards)
                    {
                        @: <option value="@board.Id" @(board.Id == Model.CurrentBoard.Id ? "selected" : "")>@board.Name</option>
                    }
                </select>

</div>
        </div>

        <div class="card-body">
            <h5 class="card-title">@Model.Ticket.Title</h5>
            
            @if (!string.IsNullOrWhiteSpace(Model.Ticket.Description))
            {
                <p class="card-text"><strong>Описание:</strong> @Model.Ticket.Description</p>
            }

            <p class="mb-1"><strong>Старт:</strong> @Model.Ticket.Start.ToString("dd.MM.yyyy HH:mm")</p>
            <p class="mb-1">
                <strong>Окончание:</strong> @(Model.Ticket.End.HasValue ? Model.Ticket.End.Value.ToString("dd.MM.yyyy HH:mm") : "—")
            </p>
        </div>

        <div class="card-footer text-muted">
            <small>Информация о тикете</small>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        document.addEventListener("DOMContentLoaded", () => {

            // Изменение Board
            const boardSelect = document.querySelector("#boardSelect");
            if (boardSelect) {
                boardSelect.addEventListener("change", async (e) => {
                    const newBoardId = parseInt(e.target.value, 10);
                    const ticketId = parseInt(e.target.dataset.ticketid, 10);

                    try {
                        await fetch("/Ticket/Move", {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify({ ticketId, newBoardId })
                        });
                        alert("✅ Тикет перемещён на новый Board!");
                    } catch (err) {
                        alert("Ошибка при перемещении Board");
                    }
                });
            }

            // Изменение Статуса
            const statusSelect = document.querySelector("#statusSelect");
            if (statusSelect) {
                statusSelect.addEventListener("change", async (e) => {
                    const newStatus = e.target.value;
                    const ticketId = parseInt(e.target.dataset.ticketid, 10);

                    try {
                        await fetch("/Ticket/Move", {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify({ ticketId, newStatus })
                        });
                        alert("✅ Статус тикета изменён!");
                    } catch (err) {
                        alert("Ошибка при изменении статуса");
                    }
                });
            }
        });
    </script>
}